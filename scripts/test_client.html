<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesBoost WebSocket æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #00d9ff; }
        .config-panel {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .config-panel label { font-size: 12px; color: #888; }
        .config-panel input {
            width: 100%;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0f0f23;
            color: #fff;
            font-size: 14px;
        }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-connect { background: #00d9ff; color: #000; }
        .btn-connect:hover { background: #00b8d9; }
        .btn-disconnect { background: #ff4757; color: #fff; }
        .btn-send { background: #2ed573; color: #000; }
        .btn-send:hover { background: #26c066; }
        .btn-clear { background: #666; color: #fff; }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }
        .status.connected { background: #2ed573; color: #000; }
        .status.disconnected { background: #ff4757; }
        .main-area { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .chat-area { background: #16213e; border-radius: 8px; padding: 15px; }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸš€ SalesBoost WebSocket æµ‹è¯•å®¢æˆ·ç«¯</h1>
    <div class="config-panel">
        <div>
            <label>Course ID</label>
            <input type="text" id="courseId" value="course-credit-card-001">
        </div>
        <div>
            <label>Scenario ID</label>
            <input type="text" id="scenarioId" value="scenario-annual-fee-001">
        </div>
        <div>
            <label>Persona ID</label>
            <input type="text" id="personaId" value="persona-wang-001">
        </div>
        <div>
            <label>User ID</label>
            <input type="text" id="userId" value="test-user-001">
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-connect" onclick="connect()">ğŸ”Œ è¿æ¥</button>
        <button class="btn-disconnect" onclick="disconnect()">âŒ æ–­å¼€</button>
        <button class="btn-clear" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <span id="status" class="status disconnected">æœªè¿æ¥</span>
    </div>

    <div class="main-area">
        <div class="chat-area">
            <div style="margin-bottom: 15px;">
                <input type="text" id="messageInput" placeholder="è¾“å…¥é”€å”®è¯æœ¯..." 
                    style="width: calc(100% - 90px); padding: 12px; border: 1px solid #333; 
                    border-radius: 6px; background: #0f0f23; color: #fff; font-size: 14px;"
                    onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="btn-send" onclick="sendMessage()" style="width: 80px;">å‘é€</button>
            </div>
            <div id="logArea" style="height: 500px; overflow-y: auto; background: #0f0f23; 
                border-radius: 6px; padding: 15px; font-family: monospace; font-size: 13px;">
            </div>
        </div>
        <div class="info-panel" style="background: #16213e; border-radius: 8px; padding: 15px;">
            <h3 style="margin-bottom: 15px; color: #00d9ff;">ğŸ“Š ä¼šè¯çŠ¶æ€</h3>
            <div id="stateInfo">
                <p><strong>é˜¶æ®µ:</strong> <span id="currentStage">-</span></p>
                <p><strong>è½®æ¬¡:</strong> <span id="turnCount">0</span></p>
                <p><strong>NPCæƒ…ç»ª:</strong> <span id="npcMood">-</span></p>
                <p><strong>æœ€æ–°è¯„åˆ†:</strong> <span id="lastScore">-</span></p>
            </div>
            <hr style="border-color: #333; margin: 15px 0;">
            <h3 style="margin-bottom: 15px; color: #00d9ff;">ğŸ“ æ¶ˆæ¯ç±»å‹å›¾ä¾‹</h3>
            <p><span style="color: #2ed573;">â– </span> NPC å®¢æˆ·å›å¤</p>
            <p><span style="color: #ffa502;">â– </span> COACH æ•™ç»ƒå»ºè®®</p>
            <p><span style="color: #9b59b6;">â– </span> STRATEGY ç­–ç•¥åˆ†æ</p>
            <p><span style="color: #e74c3c;">â– </span> GUIDANCE ç­–ç•¥æŒ‡å¯¼</p>
            <p><span style="color: #3498db;">â– </span> ADOPTION é‡‡çº³æ£€æµ‹</p>
            <p><span style="color: #00d9ff;">â– </span> SYSTEM ç³»ç»Ÿæ¶ˆæ¯</p>
            <p><span style="color: #ff4757;">â– </span> ERROR é”™è¯¯</p>
        </div>
    </div>
</div>

<script>
let ws = null;
const logArea = document.getElementById('logArea');

function getWsUrl() {
    const courseId = document.getElementById('courseId').value;
    const scenarioId = document.getElementById('scenarioId').value;
    const personaId = document.getElementById('personaId').value;
    const userId = document.getElementById('userId').value;
    return `ws://localhost:8000/ws/train?course_id=${courseId}&scenario_id=${scenarioId}&persona_id=${personaId}&user_id=${userId}`;
}

function connect() {
    if (ws && ws.readyState === WebSocket.OPEN) {
        log('SYSTEM', 'å·²ç»è¿æ¥', '#00d9ff');
        return;
    }
    const url = getWsUrl();
    log('SYSTEM', `æ­£åœ¨è¿æ¥: ${url}`, '#00d9ff');
    ws = new WebSocket(url);
    
    ws.onopen = () => {
        document.getElementById('status').textContent = 'å·²è¿æ¥';
        document.getElementById('status').className = 'status connected';
        log('SYSTEM', 'âœ… WebSocket è¿æ¥æˆåŠŸ', '#2ed573');
    };
    
    ws.onclose = () => {
        document.getElementById('status').textContent = 'æœªè¿æ¥';
        document.getElementById('status').className = 'status disconnected';
        log('SYSTEM', 'âŒ WebSocket è¿æ¥å…³é—­', '#ff4757');
    };
    
    ws.onerror = (e) => {
        log('ERROR', `WebSocket é”™è¯¯: ${e.message || 'æœªçŸ¥é”™è¯¯'}`, '#ff4757');
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
    };
}
</script>

<script>
function handleMessage(data) {
    const type = data.type;
    
    switch(type) {
        case 'init':
            log('SYSTEM', `ä¼šè¯åˆå§‹åŒ– | Session: ${data.session_id}`, '#00d9ff');
            log('SYSTEM', `å®¢æˆ·: ${data.persona?.name} (${data.persona?.occupation})`, '#00d9ff');
            log('SYSTEM', `åœºæ™¯: ${data.scenario?.name}`, '#00d9ff');
            document.getElementById('currentStage').textContent = data.stage;
            break;
            
        case 'turn_result':
            document.getElementById('turnCount').textContent = data.turn;
            document.getElementById('currentStage').textContent = data.stage;
            document.getElementById('npcMood').textContent = (data.npc_mood * 100).toFixed(0) + '%';
            document.getElementById('lastScore').textContent = data.overall_score?.toFixed(1) || '-';
            
            // NPC å›å¤
            log('NPC', data.npc_response, '#2ed573');
            
            // Coach å»ºè®®
            if (data.coach_suggestion) {
                log('COACH', `ğŸ’¡ ${data.coach_suggestion}`, '#ffa502');
                if (data.coach_example) {
                    log('COACH', `ğŸ“ ç¤ºä¾‹: "${data.coach_example}"`, '#ffa502');
                }
            }
            
            // ã€èƒ½åŠ›é—­ç¯ã€‘ç­–ç•¥åˆ†æ
            if (data.strategy_analysis) {
                const sa = data.strategy_analysis;
                const optimalIcon = sa.is_optimal ? 'âœ…' : 'âš ï¸';
                log('STRATEGY', `${optimalIcon} æƒ…å¢ƒ: ${sa.situation_type} | ä½ çš„ç­–ç•¥: ${sa.strategy_chosen} | é”€å† ç­–ç•¥: ${sa.golden_strategy}`, '#9b59b6');
                if (!sa.is_optimal) {
                    log('STRATEGY', `ğŸ“ˆ ${sa.optimality_reason}`, '#9b59b6');
                }
            }
            
            // ã€èƒ½åŠ›é—­ç¯ã€‘ç­–ç•¥çº§æŒ‡å¯¼
            if (data.strategy_guidance) {
                const sg = data.strategy_guidance;
                log('GUIDANCE', `ğŸ¯ é”€å† ç­–ç•¥: ${sg.golden_strategy}`, '#e74c3c');
                log('GUIDANCE', `ğŸ’¡ è¿‡æ¸¡å»ºè®®: ${sg.transition_suggestion}`, '#e74c3c');
                log('GUIDANCE', `ğŸ“ ç¤ºä¾‹: "${sg.example_utterance}"`, '#e74c3c');
            }
            
            // ã€èƒ½åŠ›é—­ç¯ã€‘é‡‡çº³åˆ†æ
            if (data.adoption_analysis) {
                const aa = data.adoption_analysis;
                const effectiveIcon = aa.is_effective ? 'ğŸ‰' : 'ğŸ“Š';
                log('ADOPTION', `${effectiveIcon} å»ºè®®é‡‡çº³æ£€æµ‹: ${aa.adoption_style} | æœ‰æ•ˆ: ${aa.is_effective} | æ•ˆæœåˆ†: ${aa.effectiveness_score?.toFixed(2)}`, '#3498db');
                if (aa.skill_delta) {
                    const deltaStr = Object.entries(aa.skill_delta)
                        .filter(([k,v]) => v !== 0)
                        .map(([k,v]) => `${k}: ${v > 0 ? '+' : ''}${v.toFixed(2)}`)
                        .join(' | ');
                    if (deltaStr) {
                        log('ADOPTION', `ğŸ“ˆ èƒ½åŠ›å˜åŒ–: ${deltaStr}`, '#3498db');
                    }
                }
            }
            
            // è¯„åˆ†
            if (data.scores) {
                const scoreStr = Object.entries(data.scores)
                    .map(([k,v]) => `${k}: ${v.toFixed(1)}`)
                    .join(' | ');
                log('SYSTEM', `ğŸ“Š è¯„åˆ†: ${scoreStr} | æ€»åˆ†: ${data.overall_score?.toFixed(1)}`, '#00d9ff');
            }
            
            // åˆè§„é£é™©
            if (data.compliance_risks && data.compliance_risks.length > 0) {
                data.compliance_risks.forEach(r => {
                    log('ERROR', `âš ï¸ åˆè§„é£é™©: ${r.type} - ${r.reason}`, '#ff4757');
                });
            }
            break;
            
        case 'stage_change':
            log('SYSTEM', `ğŸ¯ é˜¶æ®µå˜åŒ–: ${data.from} â†’ ${data.to}`, '#00d9ff');
            log('SYSTEM', `åŸå› : ${data.reason}`, '#00d9ff');
            document.getElementById('currentStage').textContent = data.to;
            break;
            
        case 'session_complete':
            log('SYSTEM', `ğŸ‰ ${data.message}`, '#2ed573');
            log('SYSTEM', `æœ€ç»ˆé˜¶æ®µ: ${data.final_stage} | æ€»è½®æ¬¡: ${data.total_turns}`, '#2ed573');
            break;
            
        case 'pong':
            break;
            
        case 'error':
            log('ERROR', data.message, '#ff4757');
            break;
            
        default:
            log('SYSTEM', JSON.stringify(data, null, 2), '#888');
    }
}

function disconnect() {
    if (ws) {
        ws.close();
        ws = null;
    }
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('ERROR', 'è¯·å…ˆè¿æ¥ WebSocket', '#ff4757');
        return;
    }
    log('USER', message, '#fff');
    ws.send(JSON.stringify({ type: 'message', content: message }));
    input.value = '';
}

function log(source, message, color) {
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.style.borderLeft = `3px solid ${color}`;
    div.style.paddingLeft = '10px';
    div.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color};font-weight:bold">[${source}]</span> ${message}`;
    logArea.appendChild(div);
    logArea.scrollTop = logArea.scrollHeight;
}

function clearLog() {
    logArea.innerHTML = '';
}

// å¿ƒè·³
setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping' }));
    }
}, 30000);
</script>
</body>
</html>
